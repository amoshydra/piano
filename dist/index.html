<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Web Piano</title>
		<style>
			* {
				box-sizing: border-box;
			}
			#piano {
				display: flex;
				justify-content: center;
				align-items: flex-end;
				height: 200px;
				position: relative;

				--key-width: 2rem;
				--key-height: 10rem;
				--key-background: white;
			}
			.key {
				border: 1px solid #000;
				cursor: pointer;
				display: flex;
				justify-content: center;
				align-items: center;
				color: white;
				font-weight: bold;
				user-select: none;
				background: var(--key-background);
				height: var(--key-height);
				width: var(--key-width);
			}
			.white-key {
				--key-background: white;
				z-index: 1;
				justify-content: center;
				align-items: flex-end;
				color: #fefefe;
			}
			.black-key {
				--key-background: black;
				width: 0;
				z-index: 2;
				position: relative;
				background: transparent;
				border: none;
				&::before {
					content: '';
					position: absolute;
					background: var(--key-background);
					top: 0px;
					left: 0;
					display: block;
					transform: translateX(-50%);
					width: calc(0.8 * var(--key-width));
					height: calc(0.65 * var(--key-height));
					border: 4px solid white;
					border-top: 1px solid black;
					border-bottom: none;
				}
			}
			.white-key:active,
			.white-key.active {
				--key-background: #ccc;
			}
			.black-key:active,
			.black-key.active {
				--key-background: #555;
			}
		</style>
	</head>
	<body>
		<div style="font-family: Arial, sans-serif; text-align: center; padding: 20px">
			<h1>Piano</h1>
			<div
				tabindex="0"
				id="piano"
				style="margin: 0 auto; padding: 20px; background: #f0f0f0; border-radius: 10px"
			></div>
			<div style="margin-top: 20px; font-size: 14px; color: #666"></div>
		</div>

		<script>
			const startFrequency = 440;
			const keys = [
				{ note: 'F#', key: '`', color: 'black' },
				{ note: 'G', key: 'tab', color: 'white' },
				{ note: 'G#', key: '1', color: 'black' },
				{ note: 'A', key: 'q', color: 'white', start: true },
				{ note: 'A#', key: '2', color: 'black' },
				{ note: 'B', key: 'w', color: 'white' },
				{ note: 'C', key: 'e', color: 'white' },
				{ note: 'C#', key: '4', color: 'black' },
				{ note: 'D', key: 'r', color: 'white' },
				{ note: 'D#', key: '5', color: 'black' },
				{ note: 'E', key: 't', color: 'white' },
				{ note: 'F', key: 'y', color: 'white' },
				{ note: 'F#', key: '7', color: 'black' },
				{ note: 'G', key: 'u', color: 'white' },
				{ note: 'G#', key: '8', color: 'black' },
				{ note: 'A', key: 'i', color: 'white' },
				{ note: 'A#', key: '9', color: 'black' },
				{ note: 'B', key: 'o', color: 'white' },
				{ note: 'C', key: 'p', color: 'white' },
				{ note: 'C#', key: '-', color: 'black' },
				{ note: 'D', key: '[', color: 'white' },
				{ note: 'D#', key: '=', color: 'black' },
				{ note: 'E', key: ']', color: 'white' },
				{ note: 'F', key: '\\', color: 'white' },
				{ note: 'F#', key: 'backspace', color: 'black' }
			];
			const keyOffet = -1 * keys.findIndex((k) => k.start === true);

			// Initialize Web Audio API
			const audioContext = new (window.AudioContext || window.webkitAudioContext)();

			// Create piano keys
			const piano = document.getElementById('piano');
			keys.forEach((key, index) => {
				const keyElement = document.createElement('div');
				keyElement.className = `key ${key.color}-key`;
				keyElement.textContent = key.note;
				keyElement.dataset.note = `${key.note}${key.octave}`;
				keyElement.dataset.key = key.key;
				keyElement.dataset.index = index;

				keyElement.addEventListener('pointerdown', () => playNote(index));
				keyElement.addEventListener('pointerup', () => keyElement.classList.remove('active'));

				piano.appendChild(keyElement);
			});

			// Keyboard event listeners
			document.addEventListener('keydown', (e) => {
				const keyIndex = keys.findIndex((k) => k.key === e.key.toLowerCase());
				if (keyIndex >= 0) {
					e.preventDefault();
					if (e.repeat) return;
					playNote(keyIndex);
				}
			});

			document.addEventListener('keyup', (e) => {
				const keyElement = document.querySelector(`[data-key="${e.key.toLowerCase()}"]`);
				if (keyElement) {
					keyElement.classList.remove('active');
				}
			});

			// Play note function using Web Audio API
			function playNote(noteIndex) {
				const keyElement = document.querySelector(`[data-index="${noteIndex}"]`);
				if (keyElement) {
					keyElement.classList.add('active');
				}

				// Parse note and octave
				const note = keyElement.dataset.note;
				const noteName = note.replace(/\d/g, '');

				const semitones = noteIndex + keyOffet;

				const frequency = startFrequency * Math.pow(2, semitones / 12);
				console.log(`${semitones}\t${frequency}`);

				// Create oscillator
				const oscillator = audioContext.createOscillator();
				oscillator.type = 'sine';
				oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

				// Create gain node
				const gainNode = audioContext.createGain();
				gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
				gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 1);

				// Connect nodes
				oscillator.connect(gainNode);
				gainNode.connect(audioContext.destination);

				// Start and stop oscillator
				oscillator.start(audioContext.currentTime);
				oscillator.stop(audioContext.currentTime + 1);

				// Remove active class after sound ends
				setTimeout(() => {
					if (keyElement) {
						keyElement.classList.remove('active');
					}
				}, 500);
			}
		</script>
	</body>
</html>
